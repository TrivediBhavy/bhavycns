<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Secure Messaging App</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; padding: 10px; }
    textarea, input, button { width: 100%; margin-top: 10px; padding: 8px; }
    .section { margin-bottom: 30px; }
  </style>
</head>
<body>

  <h2>üîê Secure Messaging App (AES + RSA)</h2>

  <div class="section">
    <h3>1. Generate RSA Keys</h3>
    <button onclick="generateRSAKeys()">Generate RSA Key Pair</button>
    <textarea id="publicKey" placeholder="Public Key (Share this)"></textarea>
    <textarea id="privateKey" placeholder="Private Key (Keep this secret)"></textarea>
  </div>

  <div class="section">
    <h3>2. Encrypt Message</h3>
    <textarea id="message" placeholder="Enter message to encrypt"></textarea>
    <button onclick="encryptMessage()">Encrypt</button>
    <textarea id="encryptedMessage" placeholder="Encrypted Message"></textarea>
    <textarea id="encryptedAESKey" placeholder="Encrypted AES Key"></textarea>
  </div>

  <div class="section">
    <h3>3. Decrypt Message</h3>
    <button onclick="decryptMessage()">Decrypt</button>
    <textarea id="decryptedMessage" placeholder="Decrypted Message"></textarea>
  </div>

  <script>
    let aesKey, iv;

    // Generate RSA Key Pair
    async function generateRSAKeys() {
      const keyPair = await window.crypto.subtle.generateKey(
        { name: "RSA-OAEP", modulusLength: 2048, publicExponent: new Uint8Array([1, 0, 1]), hash: "SHA-256" },
        true,
        ["encrypt", "decrypt"]
      );
      const pubKey = await window.crypto.subtle.exportKey("spki", keyPair.publicKey);
      const privKey = await window.crypto.subtle.exportKey("pkcs8", keyPair.privateKey);
      document.getElementById("publicKey").value = btoa(String.fromCharCode(...new Uint8Array(pubKey)));
      document.getElementById("privateKey").value = btoa(String.fromCharCode(...new Uint8Array(privKey)));
      window.publicKeyObj = keyPair.publicKey;
      window.privateKeyObj = keyPair.privateKey;
      alert("RSA Key Pair Generated!");
    }

    // Encrypt Message using AES and encrypt AES key with RSA
    async function encryptMessage() {
      const message = document.getElementById("message").value;

      // Generate AES Key
      aesKey = await window.crypto.subtle.generateKey(
        { name: "AES-GCM", length: 256 },
        true,
        ["encrypt", "decrypt"]
      );

      iv = window.crypto.getRandomValues(new Uint8Array(12)); // Initialization vector

      // Encrypt Message
      const encoded = new TextEncoder().encode(message);
      const encryptedData = await window.crypto.subtle.encrypt(
        { name: "AES-GCM", iv },
        aesKey,
        encoded
      );
      const encryptedMsgBase64 = btoa(String.fromCharCode(...new Uint8Array(encryptedData)));
      document.getElementById("encryptedMessage").value = encryptedMsgBase64;

      // Encrypt AES Key using RSA
      const exportedAESKey = await window.crypto.subtle.exportKey("raw", aesKey);
      const publicKeyRaw = Uint8Array.from(atob(document.getElementById("publicKey").value), c => c.charCodeAt(0));
      const importedPubKey = await window.crypto.subtle.importKey(
        "spki",
        publicKeyRaw.buffer,
        { name: "RSA-OAEP", hash: "SHA-256" },
        false,
        ["encrypt"]
      );
      const encryptedAESKey = await window.crypto.subtle.encrypt(
        { name: "RSA-OAEP" },
        importedPubKey,
        exportedAESKey
      );
      const encryptedAESKeyBase64 = btoa(String.fromCharCode(...new Uint8Array(encryptedAESKey)));
      document.getElementById("encryptedAESKey").value = encryptedAESKeyBase64;

      alert("Message Encrypted!");
    }

    // Decrypt Message
    async function decryptMessage() {
      const encryptedAESKeyBase64 = document.getElementById("encryptedAESKey").value;
      const encryptedMessageBase64 = document.getElementById("encryptedMessage").value;

      const encryptedAESKey = Uint8Array.from(atob(encryptedAESKeyBase64), c => c.charCodeAt(0));
      const encryptedMessage = Uint8Array.from(atob(encryptedMessageBase64), c => c.charCodeAt(0));

      const privateKeyRaw = Uint8Array.from(atob(document.getElementById("privateKey").value), c => c.charCodeAt(0));
      const importedPrivKey = await window.crypto.subtle.importKey(
        "pkcs8",
        privateKeyRaw.buffer,
        { name: "RSA-OAEP", hash: "SHA-256" },
        false,
        ["decrypt"]
      );

      // Decrypt AES key
      const rawAESKey = await window.crypto.subtle.decrypt(
        { name: "RSA-OAEP" },
        importedPrivKey,
        encryptedAESKey
      );

      const aesKey = await window.crypto.subtle.importKey(
        "raw",
        rawAESKey,
        { name: "AES-GCM" },
        false,
        ["decrypt"]
      );

      // Decrypt message
      const decryptedData = await window.crypto.subtle.decrypt(
        { name: "AES-GCM", iv },
        aesKey,
        encryptedMessage
      );

      const decoded = new TextDecoder().decode(decryptedData);
      document.getElementById("decryptedMessage").value = decoded;
      alert("Message Decrypted!");
    }
  </script>

</body>
</html>